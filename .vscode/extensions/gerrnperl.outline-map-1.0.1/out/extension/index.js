(()=>{"use strict";var t={2206:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.throttle=e.debounce=e.PinStatus=e.DiagnosticStats=e.SymbolNode=void 0;const n=i(9496),s=i(487);class o{constructor(t){this.diagnosticStats=new r,this.kind=n.SymbolKind[t.kind],this.name=t.name,this.detail=t.detail,this.expand=!1,this.inView=!1,this.focus=!1,this.range={start:new n.Position(t.range.start.line,t.range.start.character),end:new n.Position(t.range.end.line,t.range.end.character)},this.children=[],this.selector=["#outline-root"]}static fromDocumentSymbols(t){const e=[],i=s.config.hiddenItem();return function t(e,n){e.sort(((t,e)=>t.range.start.line-e.range.start.line)),e.forEach((e=>{const s=new o(e);i.includes(s.kind.toLowerCase())||(Array.isArray(n)?(n.push(s),s.selector=s.selector.concat(`[data-key="${s.kind}-${s.name}"]`)):(s.selector=n.selector.concat(`[data-key="${s.kind}-${s.name}"]`),n.children.push(s)),e.children.length>0&&t(e.children,s))}))}(t,e),e}}e.SymbolNode=o;class r{constructor(){this.errorCount=0,this.warningCount=0,this.hasErrorInChildren=!1,this.hasWarnInChildren=!1}clear(){this.errorCount=0,this.warningCount=0,this.hasErrorInChildren=!1,this.hasWarnInChildren=!1}add(t,e=!1){e?"error"===t?this.hasErrorInChildren=!0:this.hasWarnInChildren=!0:"error"===t?this.errorCount++:this.warningCount++}getStat(){return this.errorCount>0?{type:"error",count:this.errorCount}:this.hasErrorInChildren?{type:"error",count:-1}:this.warningCount>0?{type:"warning",count:this.warningCount}:this.hasWarnInChildren?{type:"warning",count:-1}:{type:"none",count:0}}}var a;e.DiagnosticStats=r,(a=e.PinStatus||(e.PinStatus={}))[a.unpinned=0]="unpinned",a[a.pinned=1]="pinned",a[a.frozen=2]="frozen",e.debounce=function(t,e){let i=null;return function(...n){i&&clearTimeout(i),i=setTimeout((()=>{t.apply(this,n)}),e)}},e.throttle=function(t,e){let i=!1;return function(...n){i||(t.apply(this,n),i=!0,setTimeout((()=>i=!1),e))}}},9097:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.commandList=void 0;const n=i(9496),s=i(487),o=i(2206);function r(t,e=1){t.postMessage({type:"changeDepth",data:{delta:e}})}function a(t,e){t.pin(e),n.commands.executeCommand("setContext","outline-map.pin-status",e)}s.config.defaultMaxDepth()>0&&n.commands.executeCommand("setContext","outline-map.defaultMaxDepthSet",!0),n.commands.executeCommand("setContext","outline-map.pin-status",o.PinStatus.unpinned),e.commandList=[{name:"outline-map.reduceDepth",fn:function(t){r(t,-1)}},{name:"outline-map.addDepth",fn:function(t){r(t,1)}},{name:"outline-map.pin",fn:function(t){a(t,o.PinStatus.pinned)}},{name:"outline-map.unpin",fn:function(t){a(t,o.PinStatus.unpinned)}},{name:"outline-map.freeze",fn:function(t){a(t,o.PinStatus.frozen)}},{name:"outline-map.focusOutline",fn:function(t){t.postMessage({type:"focus"})}}]},487:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.config=void 0;const n=i(9496);function s(t,e="outline-map"){return n.workspace.getConfiguration(e)?.get(t)}e.config={color:()=>s("color"),follow:()=>s("follow"),hiddenItem:()=>s("hiddenItem"),defaultMaxDepth:()=>s("defaultMaxDepth"),customFont:()=>s("customFont"),customCSS:()=>s("customCSS"),debug:()=>s("debug")}},1502:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.OutlineView=void 0;const n=i(487),s=i(9496),o=i(2206);e.OutlineView=class{constructor(t){this.focusing=new Set,this.prevSelections=[],this.inView=new Set,this.hasDiagnostic=new Set,this.pinStatus=o.PinStatus.unpinned,this.extensionUri=t.extensionUri}pin(t){this.pinStatus=t}resolveWebviewView(t){this.view=t,this.view.webview.options={enableScripts:!0,localResourceRoots:[this.extensionUri]},this.render(),setTimeout((()=>{this.build()}),1e3),this.view.onDidChangeVisibility((()=>{this.view?.visible&&s.window.activeTextEditor&&this.build(),this.view?.visible||(this.outlineTree=void 0,this.inView.clear(),this.focusing.clear(),this.prevSelections=[])})),this.view.webview.onDidReceiveMessage((t=>{"goto"===t.type&&s.commands.executeCommand("editor.action.goToLocations",s.window.activeTextEditor?.document.uri,new s.Position(t.data.position.line,t.data.position.character),[],"goto","")}))}build(){this.update(s.window.activeTextEditor?.document||s.window.visibleTextEditors[0].document),this.postMessage({type:"config",data:{color:n.config.color(),depth:n.config.defaultMaxDepth(),debug:n.config.debug()}})}postMessage(t){this.view?.webview.postMessage(t)}focus(t){if(!this.outlineTree)return;if(this.pinStatus===o.PinStatus.frozen)return;const e=t.length!==this.prevSelections.length||t.some(((t,e)=>t.start.line!==this.prevSelections[e].start.line||t.end.line!==this.prevSelections[e].end.line));if(!e)return;this.prevSelections=t.slice();const i=[];for(const t of this.focusing)t.focus=!1;for(const e of t){const{inRange:t}=this.outlineTree.findNodesIn(e);t?.forEach((t=>{t.focus=!0,this.focusing.has(t)||this.focusing.add(t)}))}for(const t of this.focusing)i.push({type:"update",selector:t.selector.join(" >.outline-children> "),property:"focus",value:t.focus}),t.focus||this.focusing.delete(t);this.postMessage({type:"update",data:{patches:i}})}updateViewPort(t){if(!this.outlineTree)return;if(this.pinStatus===o.PinStatus.frozen)return;const e=[];for(const t of this.inView)t.inView=!1,t.expand=!1;const{inRange:i,involves:n}=this.outlineTree.findNodesIn(t);i.forEach((t=>{t.inView=!0,t.expand=!0,this.inView.has(t)||this.inView.add(t)})),this.pinStatus===o.PinStatus.unpinned&&n.forEach((t=>{t.expand=!0,this.inView.has(t)||this.inView.add(t)}));for(const t of this.inView)e.push({type:"update",selector:t.selector.join(" >.outline-children> "),property:"inview",value:t.inView}),this.pinStatus===o.PinStatus.unpinned&&e.push({type:"update",selector:t.selector.join(" >.outline-children> "),property:"expand",value:t.expand}),t.inView||t.expand||this.inView.delete(t);this.postMessage({type:"update",data:{patches:e}})}updateDiagnostics(t){if(!this.outlineTree)return;const e=[];for(const t of this.hasDiagnostic)t.diagnosticStats.clear();t=t.filter((t=>t.severity===s.DiagnosticSeverity.Error||t.severity===s.DiagnosticSeverity.Warning)).sort(((t,e)=>t.range.start.line-e.range.start.line));let i=0;const n=e=>{if(i>=t.length)return e.diagnosticStats.getStat();const o=t[i];if(o.range.start.line>e.range.end.line)return e.diagnosticStats.getStat();if(o.range.end.line<e.range.start.line)return e.diagnosticStats.getStat();for(const t of e.children){const s=n(t);if("none"!==s.type)return e.diagnosticStats.add(s.type,!0),this.hasDiagnostic.add(e),i++,n(e),e.diagnosticStats.getStat()}return e.diagnosticStats.add(o.severity===s.DiagnosticSeverity.Error?"error":"warning",!1),this.hasDiagnostic.add(e),i++,n(e),e.diagnosticStats.getStat()};for(const t of this.outlineTree.getNodes())n(t);for(const t of this.hasDiagnostic){const i=t.diagnosticStats.getStat();e.push({type:"update",selector:t.selector.join(" >.outline-children> "),property:"diagnostictype",value:i.type},{type:"update",selector:t.selector.join(" >.outline-children> "),property:"diagnosticcount",value:i.count}),"none"===i.type&&this.hasDiagnostic.delete(t)}this.postMessage({type:"update",data:{patches:e}})}render(){if(!this.view)return;const t=t=>this.view?.webview.asWebviewUri(s.Uri.joinPath(this.extensionUri,...t.split("/")));this.view.webview.html=`\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t  <head>\n\t\t\t\t<meta charset="UTF-8">\n\t\t\t\t\x3c!-- <link href="${t("node_modules/@vscode/codicons/dist/codicon.css")}" rel="stylesheet"> --\x3e\n\t\t\t\t\x3c!-- <link href="${t("out/webview/style.css")}" rel="stylesheet"> --\x3e\n\t\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t\t\t\t\x3c!-- <script type="module" src="${t("node_modules/@vscode/webview-ui-toolkit/dist/toolkit.min.js")}"><\/script> --\x3e\n\t\t\t\t<title>Outline Map</title>\n\t\t\t\t<style>\n\t\t\t\t\t:not(.codicon) {\n\t\t\t\t\t\tfont-family: ${n.config.customFont()||"system-ui"}\n\t\t\t\t\t}\n\t\t\t\t\t${n.config.customCSS()}\n\t\t\t\t</style>\n\t\t\t\t<style id="color-style"></style>\n\t\t\t  </head>\n\t\t\t  <body>\n\t\t\t\t<script type="module" src="${t("out/webview/index.js")}"><\/script>\n\t\t\t  </body>\n\t\t\t</html>`}update(t){const e=new r(t);e.updateSymbols().then((()=>{const t=new a(this.outlineTree?.getNodes()||[],e.getNodes()).getOps();this.postMessage({type:"update",data:{patches:t}}),this.outlineTree=e}))}};class r{constructor(t){this.nodes=[],this.MAX_ATTEMPTS=10,this.attempts=0,this.textDocument=t}getNodes(){return this.nodes}async updateSymbols(){const t=await s.commands.executeCommand("vscode.executeDocumentSymbolProvider",this.textDocument.uri);if(t)n.config.debug()&&console.log(`[Outline-map]: Got symbols from ${this.textDocument.uri.toString()}.`,t),this.nodes=o.SymbolNode.fromDocumentSymbols(t),this.attempts=0;else{if(!(this.attempts<this.MAX_ATTEMPTS))throw new Error(`Outline-map: Failed to get symbols of ${this.textDocument.uri.toString()}.`);this.attempts++,setTimeout((()=>this.updateSymbols()),300),console.log(`Outline-map: Failed to get symbols of ${this.textDocument.uri.toString()}. Attempt ${this.attempts} of ${this.MAX_ATTEMPTS}.`)}}findNodesIn(t){const e=[],i=[];return function n(s){let o=!1;return s.forEach((s=>{const r=s.range.start.line,a=s.range.end.line,c=t.start.line,d=t.end.line;if(d>=r&&c<=r&&(e.push(s),o=!0),r<=d&&a>=c&&s.children){const t=n(s.children);o=o||t,i.push(s)}d<=a&&c>=r&&!o&&(e.push(s),o=!0)})),o}(this.nodes),{inRange:e,involves:i}}}class a{constructor(t,e){this.ops=[],this.oldNode=t,this.newNode=e,this.patch()}getOps(){return this.ops}patch(){this.updateChildren(this.oldNode,this.newNode,["#outline-root"])}sameNode(t,e){return t.name===e.name&&t.kind===e.kind}patchNode(t,e,i){const n=["name","kind","children"],s=Object.keys(t).filter((t=>!n.includes(t))),o=i.concat(`[data-key="${e.kind}-${e.name}"]`).join(" >.outline-children> ");for(const i of s){const n=Object.getOwnPropertyDescriptor(t,i)?.value,s=Object.getOwnPropertyDescriptor(e,i)?.value;JSON.stringify(n)!==JSON.stringify(s)&&this.ops.push({selector:o,type:"update",property:i,value:"object"==typeof s?JSON.stringify(s):s})}const r=t.children&&t.children.length>0,a=e.children&&e.children.length>0;r&&a?this.updateChildren(t.children,e.children,i.concat(`[data-key="${e.kind}-${e.name}"]`)):r&&!a?this.ops.push({selector:o,type:"delete",nodes:t.children}):!r&&a&&this.ops.push({selector:o,type:"insert",before:null,nodes:e.children})}updateChildren(t,e,i){let n=0,s=0,o=t.length-1,r=e.length-1,a=t[n],c=e[s],d=t[o],l=e[r];const u=i.join(" >.outline-children> ");for(;n<=o&&s<=r;)if(this.sameNode(a,c))this.patchNode(a,c,i),a=t[++n],c=e[++s];else if(this.sameNode(d,l))this.patchNode(d,l,i),d=t[--o],l=e[--r];else if(this.sameNode(a,l))this.patchNode(a,l,i),this.ops.push({selector:u,type:"move",nodes:[a],before:t[o+1]||null}),a=t[++n],l=e[--r];else if(this.sameNode(d,c))this.patchNode(d,c,i),this.ops.push({selector:u,type:"move",nodes:[d],before:t[n]||null}),d=t[--o],c=e[++s];else{const e=t.findIndex((t=>this.sameNode(t,c)));if(!(e>=0)){this.ops.push({selector:u,type:"insert",nodes:[c],before:t[n]}),s++;break}this.patchNode(t[e],c,i),this.ops.push({selector:u,type:"move",nodes:[t[e]],before:t[n]||null}),t.splice(e,1)}n<=o&&this.ops.push({selector:u,type:"delete",nodes:t.slice(n,o+1)}),s<=r&&this.ops.push({selector:u,type:"insert",nodes:e.slice(s,r+1),before:t[n]||null})}}},9496:t=>{t.exports=require("vscode")}},e={};function i(n){var s=e[n];if(void 0!==s)return s.exports;var o=e[n]={exports:{}};return t[n](o,o.exports,i),o.exports}var n={};(()=>{var t=n;Object.defineProperty(t,"__esModule",{value:!0}),t.activate=void 0;const e=i(9496),s=i(1502),o=i(9097),r=i(2206),a=i(487);t.activate=function(t){const i=new s.OutlineView(t);e.window.onDidChangeActiveTextEditor((t=>{const n=t?.document||e.window.activeTextEditor?.document;n&&i.update(n)})),e.window.onDidChangeTextEditorSelection((0,r.debounce)((t=>{i.focus(t.selections),"cursor"===a.config.follow()&&i.postMessage({type:"scroll",data:{follow:"focus"}})}),300)),e.window.onDidChangeTextEditorVisibleRanges((0,r.throttle)((t=>{i.updateViewPort(t.visibleRanges[0]),"viewport"===a.config.follow()&&i.postMessage({type:"scroll",data:{follow:"in-view"}})}),100)),e.workspace.onDidChangeTextDocument((0,r.debounce)((t=>{const e=t.document;i.update(e)}),300)),e.languages.onDidChangeDiagnostics((0,r.debounce)((t=>{const n=e.window.activeTextEditor?.document.uri||t.uris[0],s=e.languages.getDiagnostics(n);i.updateDiagnostics(s)}),300)),t.subscriptions.push(e.window.registerWebviewViewProvider("outline-map-view",i),...o.commandList.map((t=>e.commands.registerCommand(t.name,t.fn.bind(null,i)))))}})();var s=exports;for(var o in n)s[o]=n[o];n.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})})();